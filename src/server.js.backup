import express from 'express';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import pg from 'pg';
import https from 'https';
import routes from './api/routes.js';

const __dirname = dirname(fileURLToPath(import.meta.url));
const app = express();

const { Pool } = pg;
const pool = new Pool({
  host: 'localhost',
  port: 5432,
  database: 'gallery',
  user: 'galleryuser',
  password: 'apple1apple'
});

app.set('trust proxy', 1);

const translateCache = new Map();

function translate(text, targetLang) {
  if (!text || targetLang === 'en') return Promise.resolve(text);
  const key = `${text.substring(0,100)}:${targetLang}`;
  if (translateCache.has(key)) return Promise.resolve(translateCache.get(key));
  
  return new Promise((resolve) => {
    const encoded = encodeURIComponent(text.substring(0, 400));
    https.get(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${targetLang}&dt=t&q=${encoded}`, (res) => {
      let data = '';
      res.on('data', c => data += c);
      res.on('end', () => {
        try {
          const r = JSON.parse(data);
          const translated = r[0].map(x => x[0]).join('');
          translateCache.set(key, translated);
          resolve(translated);
        } catch(e) { resolve(text); }
      });
    }).on('error', () => resolve(text));
    setTimeout(() => resolve(text), 2000);
  });
}

const defaultSeo = {
  en: { title: 'BoyVue Gallery - Free Gay Photo & Video Gallery', description: 'Browse 356,000+ free gay photos and 5,500+ videos.' },
  de: { title: 'BoyVue Galerie - Kostenlose Gay Foto & Video Galerie', description: 'Durchsuche 356.000+ kostenlose Gay Fotos und 5.500+ Videos.' },
  fr: { title: 'BoyVue Galerie - Galerie Gay Gratuite', description: 'Parcourez 356 000+ photos et vid√©os gay gratuites.' },
  es: { title: 'BoyVue Galer√≠a - Galer√≠a Gay Gratis', description: 'Explora 356.000+ fotos y videos gay gratis.' },
  nl: { title: 'BoyVue Galerij - Gratis Gay Galerij', description: 'Bekijk 356.000+ gratis gay fotos en videos.' },
  it: { title: 'BoyVue Galleria - Galleria Gay Gratuita', description: 'Sfoglia 356.000+ foto e video gay gratuiti.' },
  pt: { title: 'BoyVue Galeria - Galeria Gay Gr√°tis', description: 'Navegue por 356.000+ fotos e v√≠deos gay gr√°tis.' },
  ru: { title: 'BoyVue –ì–∞–ª–µ—Ä–µ—è - –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è Gay –ì–∞–ª–µ—Ä–µ—è', description: '–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ 356 000+ —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ.' },
  pl: { title: 'BoyVue Galeria - Darmowa Galeria Gay', description: 'PrzeglƒÖdaj 356 000+ zdjƒôƒá i film√≥w gay.' },
  ja: { title: 'BoyVue„ÇÆ„É£„É©„É™„Éº - ÁÑ°Êñô„ÇÆ„É£„É©„É™„Éº', description: '356,000+Êûö„ÅÆÂÜôÁúü„Å®ÂãïÁîª„ÇíÈñ≤Ë¶ß„ÄÇ' },
  zh: { title: 'BoyVueÂõæÂ∫ì - ÂÖçË¥πÂõæÂ∫ì', description: 'ÊµèËßà356,000+Âº†ÁÖßÁâáÂíåËßÜÈ¢ë„ÄÇ' },
  th: { title: 'BoyVue ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ', description: '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π 356,000+ ‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠' },
  tr: { title: 'BoyVue Galeri', description: '356.000+ fotoƒüraf ve video.' },
  ko: { title: 'BoyVue Í∞§Îü¨Î¶¨', description: '356,000+ ÏÇ¨ÏßÑÍ≥º ÎπÑÎîîÏò§.' },
  ar: { title: 'ŸÖÿπÿ±ÿ∂ BoyVue', description: 'ÿ™ÿµŸÅÿ≠ 356,000+ ÿµŸàÿ±ÿ© ŸàŸÅŸäÿØŸäŸà.' }
};

const viewLabels = { en: 'views', de: 'Aufrufe', fr: 'vues', es: 'vistas', nl: 'weergaven', it: 'visualizzazioni', pt: 'visualiza√ß√µes', ru: '–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤', pl: 'wy≈õwietle≈Ñ', ja: 'ÂõûË¶ñËÅ¥', zh: 'Ê¨°ËßÇÁúã', th: '‡∏Å‡∏≤‡∏£‡∏î‡∏π', tr: 'g√∂r√ºnt√ºleme', ko: 'Ï°∞Ìöå', ar: 'ŸÖÿ¥ÿßŸáÿØÿßÿ™' };
const browseLabels = { en: 'Browse', de: 'Durchsuche', fr: 'Parcourez', es: 'Explora', nl: 'Bekijk', it: 'Sfoglia', pt: 'Navegue', ru: '–ü—Ä–æ—Å–º–æ—Ç—Ä', pl: 'PrzeglƒÖdaj', ja: 'Èñ≤Ë¶ß', zh: 'ÊµèËßà', th: '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π', tr: 'G√∂z at', ko: 'Ï∞æÏïÑÎ≥¥Í∏∞', ar: 'ÿ™ÿµŸÅÿ≠' };
const supportedLangs = Object.keys(defaultSeo);

function isBot(ua) {
  return /googlebot|google-inspectiontool|bingbot|yandex|baiduspider|duckduckbot|slurp|facebookexternalhit|twitterbot|linkedinbot|applebot|petalbot|chrome-lighthouse|pinterest|whatsapp|telegram|discord/i.test(ua || '');
}

function getLang(req) {
  if (req.query.lang && supportedLangs.includes(req.query.lang)) return req.query.lang;
  const al = (req.headers['accept-language'] || '').split(',')[0]?.split('-')[0]?.toLowerCase();
  return supportedLangs.includes(al) ? al : 'en';
}

function hreflang(path) {
  const p = path.split('?')[0];
  return supportedLangs.map(l => `<link rel="alternate" hreflang="${l}" href="https://boyvue.com${p}?lang=${l}">`).join('\n') + `\n<link rel="alternate" hreflang="x-default" href="https://boyvue.com${p}">`;
}

function esc(s) { return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// Social share URLs generator
function socialShareUrls(url, title, image) {
  const encodedUrl = encodeURIComponent(url);
  const encodedTitle = encodeURIComponent(title);
  const encodedImage = encodeURIComponent(image || '');
  
  return {
    twitter: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`,
    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
    reddit: `https://reddit.com/submit?url=${encodedUrl}&title=${encodedTitle}`,
    telegram: `https://t.me/share/url?url=${encodedUrl}&text=${encodedTitle}`,
    whatsapp: `https://api.whatsapp.com/send?text=${encodedTitle}%20${encodedUrl}`,
    pinterest: `https://pinterest.com/pin/create/button/?url=${encodedUrl}&media=${encodedImage}&description=${encodedTitle}`,
    tumblr: `https://www.tumblr.com/share/link?url=${encodedUrl}&name=${encodedTitle}`,
    linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
    vk: `https://vk.com/share.php?url=${encodedUrl}&title=${encodedTitle}`,
    email: `mailto:?subject=${encodedTitle}&body=${encodedUrl}`
  };
}

function botHtml(meta, lang, path, schema, body) {
  const rtl = ['ar'].includes(lang);
  const fullUrl = `https://boyvue.com${path.split('?')[0]}`;
  const shares = socialShareUrls(fullUrl, meta.title, meta.image);
  
  return `<!DOCTYPE html>
<html lang="${lang}"${rtl?' dir="rtl"':''} prefix="og: https://ogp.me/ns#">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="index,follow,max-image-preview:large">
<title>${esc(meta.title)}</title>
<meta name="description" content="${esc(meta.description)}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="${meta.type||'website'}">
<meta property="og:site_name" content="BoyVue Gallery">
<meta property="og:title" content="${esc(meta.title)}">
<meta property="og:description" content="${esc(meta.description)}">
${meta.image?`<meta property="og:image" content="${meta.image}">
<meta property="og:image:secure_url" content="${meta.image}">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="${esc(meta.title)}">`:''}
<meta property="og:url" content="${fullUrl}">
<meta property="og:locale" content="${lang}">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@boyvue">
<meta name="twitter:creator" content="@boyvue">
<meta name="twitter:title" content="${esc(meta.title)}">
<meta name="twitter:description" content="${esc(meta.description)}">
${meta.image?`<meta name="twitter:image" content="${meta.image}">
<meta name="twitter:image:alt" content="${esc(meta.title)}">`:''}

<!-- Pinterest -->
<meta name="pinterest-rich-pin" content="true">
<meta property="article:author" content="BoyVue Gallery">

<!-- LinkedIn -->
<meta property="article:published_time" content="${new Date().toISOString()}">

<!-- Telegram -->
<meta name="telegram:channel" content="@boyvue">

<!-- WhatsApp -->
<meta property="og:whatsapp_sticker_pack_publisher" content="BoyVue">

<!-- Discord -->
<meta name="theme-color" content="#ff6600">

<!-- General -->
<link rel="canonical" href="${fullUrl}">
${hreflang(path)}
<meta name="rating" content="RTA-5042-1996-1400-1577-RTA">
<link rel="icon" href="/favicon.ico">

${schema?`<script type="application/ld+json">${JSON.stringify(schema)}</script>`:''}

<style>
body{font-family:Arial,sans-serif;background:#111;color:#fff;margin:0;padding:20px}
h1,h2{color:#f60}a{color:#f60}
.g{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px}
.i{background:#222;padding:10px;border-radius:8px}
.i img{width:100%;height:140px;object-fit:cover;border-radius:4px}
.i h3{font-size:13px;margin:8px 0 4px}
.i p{font-size:11px;color:#888;margin:0}
.c{max-width:1200px;margin:0 auto}
.share{display:flex;flex-wrap:wrap;gap:8px;margin:20px 0}
.share a{display:inline-flex;align-items:center;gap:5px;padding:8px 15px;border-radius:5px;text-decoration:none;color:#fff;font-size:13px;transition:opacity 0.2s}
.share a:hover{opacity:0.8}
.share .tw{background:#1DA1F2}
.share .fb{background:#4267B2}
.share .rd{background:#FF4500}
.share .tg{background:#0088cc}
.share .wa{background:#25D366}
.share .pi{background:#E60023}
.share .tu{background:#35465C}
.share .li{background:#0077B5}
.share .vk{background:#4C75A3}
.share .em{background:#666}
</style>
</head>
<body>
<div class="c">
<header><h1><a href="/">BoyVue Gallery</a></h1></header>
<main>
${body}
<div class="share">
  <strong style="color:#888;margin-right:10px">Share:</strong>
  <a href="${shares.twitter}" target="_blank" rel="noopener" class="tw">ùïè Twitter</a>
  <a href="${shares.facebook}" target="_blank" rel="noopener" class="fb">Facebook</a>
  <a href="${shares.reddit}" target="_blank" rel="noopener" class="rd">Reddit</a>
  <a href="${shares.telegram}" target="_blank" rel="noopener" class="tg">Telegram</a>
  <a href="${shares.whatsapp}" target="_blank" rel="noopener" class="wa">WhatsApp</a>
  <a href="${shares.pinterest}" target="_blank" rel="noopener" class="pi">Pinterest</a>
  <a href="${shares.tumblr}" target="_blank" rel="noopener" class="tu">Tumblr</a>
  <a href="${shares.linkedin}" target="_blank" rel="noopener" class="li">LinkedIn</a>
  <a href="${shares.vk}" target="_blank" rel="noopener" class="vk">VK</a>
  <a href="${shares.email}" class="em">üìß Email</a>
</div>
</main>
<footer style="margin-top:40px;padding-top:20px;border-top:1px solid #333;color:#666;font-size:12px">
<p>All models 18+ at time of depiction. RTA Labeled. &copy; 2025 BoyVue.com</p>
<p>Follow us: <a href="https://twitter.com/boyvue">Twitter</a> | <a href="https://t.me/boyvue">Telegram</a></p>
</footer>
</div>
</body>
</html>`;
}

function serveSpa(req, res) { res.sendFile(join(__dirname, '../dist/index.html')); }

console.log('Starting Gallery Platform with SEO + Social...');
app.use(express.json());
app.use('/api', routes);
app.use('/media', express.static('/var/www/html/bp/data'));

// Homepage
app.get('/', async (req, res) => {
  const ua = req.headers['user-agent'] || '';
  const lang = getLang(req);
  
  if (isBot(ua) || req.query.lang) {
    const meta = defaultSeo[lang] || defaultSeo.en;
    meta.image = 'https://boyvue.com/media/logo-social.jpg';
    const schema = {"@context":"https://schema.org","@type":"WebSite","name":"BoyVue Gallery","url":"https://boyvue.com","description":meta.description};
    
    let body = `<h2>Categories</h2><div class="g">`;
    try {
      const cats = await pool.query('SELECT id,catname,photo_count FROM category WHERE photo_count>0 ORDER BY photo_count DESC LIMIT 20');
      for (const c of cats.rows) body += `<div class="i"><h3><a href="/c/${c.id}">${esc(c.catname)}</a></h3><p>${c.photo_count.toLocaleString()} items</p></div>`;
    } catch(e) {}
    body += `</div><h2>Popular</h2><div class="g">`;
    try {
      const imgs = await pool.query('SELECT id,title,thumbnail_path,view_count FROM image ORDER BY view_count DESC LIMIT 24');
      for (const i of imgs.rows) body += `<div class="i"><a href="/v/${i.id}"><img src="/media/${i.thumbnail_path}" alt="${esc(i.title||'Video')}" loading="lazy"></a><h3><a href="/v/${i.id}">${esc((i.title||'Video').substring(0,45))}</a></h3><p>${(i.view_count||0).toLocaleString()} views</p></div>`;
    } catch(e) {}
    body += `</div>`;
    
    return res.send(botHtml(meta, lang, '/', schema, body));
  }
  serveSpa(req, res);
});

// Video/Image page
app.get('/v/:id', async (req, res) => {
  const ua = req.headers['user-agent'] || '';
  const lang = getLang(req);
  const id = parseInt(req.params.id);
  
  if (!isBot(ua) && !req.query.lang) return serveSpa(req, res);
  
  try {
    const r = await pool.query('SELECT i.*,c.catname FROM image i LEFT JOIN category c ON i.belongs_to_gallery=c.id WHERE i.id=$1', [id]);
    if (!r.rows.length) return serveSpa(req, res);
    
    const img = r.rows[0];
    let title = img.title || 'Video';
    let desc = (img.description || title).substring(0, 100);
    
    if (lang !== 'en') {
      title = await translate(title, lang);
      desc = await translate(desc, lang);
    }
    
    const isVid = /\.(mp4|webm|avi|mov|flv|mkv)$/i.test(img.local_path);
    const vl = viewLabels[lang] || 'views';
    const vc = (img.view_count||0).toLocaleString();
    
    const meta = {
      title: `${title.substring(0,50)} | BoyVue`,
      description: `${desc.substring(0,120)} - ${vc} ${vl}`,
      image: `https://boyvue.com/media/${img.thumbnail_path||img.local_path}`,
      type: isVid ? 'video.other' : 'article'
    };
    
    const schema = isVid ? {
      "@context":"https://schema.org","@type":"VideoObject","name":title,"description":meta.description,
      "thumbnailUrl":meta.image,"contentUrl":`https://boyvue.com/media/${img.local_path}`,
      "interactionStatistic":{"@type":"InteractionCounter","interactionType":"WatchAction","userInteractionCount":img.view_count||0}
    } : {"@context":"https://schema.org","@type":"ImageObject","name":title,"contentUrl":meta.image};
    
    let body = `<article><h2>${esc(title)}</h2>`;
    body += isVid ? `<video controls poster="${meta.image}" style="width:100%;max-width:800px"><source src="/media/${img.local_path}" type="video/mp4"></video>` : `<img src="/media/${img.local_path}" alt="${esc(title)}" style="width:100%;max-width:800px">`;
    body += `<p>${esc(img.description||'')}</p><p><strong>${vc} ${vl}</strong> | <a href="/c/${img.belongs_to_gallery}">${esc(img.catname||'Gallery')}</a></p></article>`;
    
    // Related
    try {
      const rel = await pool.query('SELECT id,title,thumbnail_path FROM image WHERE belongs_to_gallery=$1 AND id!=$2 ORDER BY view_count DESC LIMIT 8', [img.belongs_to_gallery, id]);
      if (rel.rows.length) {
        body += `<h3>Related</h3><div class="g">`;
        for (const x of rel.rows) body += `<div class="i"><a href="/v/${x.id}"><img src="/media/${x.thumbnail_path}" alt="${esc(x.title||'')}" loading="lazy"></a><h3><a href="/v/${x.id}">${esc((x.title||'Video').substring(0,40))}</a></h3></div>`;
        body += `</div>`;
      }
    } catch(e) {}
    
    res.send(botHtml(meta, lang, `/v/${id}`, schema, body));
  } catch(e) {
    console.error('SEO /v/:id:', e.message);
    serveSpa(req, res);
  }
});

// Category page
app.get('/c/:id', async (req, res) => {
  const ua = req.headers['user-agent'] || '';
  const lang = getLang(req);
  const id = parseInt(req.params.id);
  
  if (!isBot(ua) && !req.query.lang) return serveSpa(req, res);
  
  try {
    const r = await pool.query('SELECT * FROM category WHERE id=$1', [id]);
    if (!r.rows.length) return serveSpa(req, res);
    
    const cat = r.rows[0];
    let name = cat.catname;
    if (lang !== 'en') name = await translate(name, lang);
    
    const bl = browseLabels[lang] || 'Browse';
    const pc = (cat.photo_count||0).toLocaleString();
    
    // Get first image for social sharing
    let coverImage = 'https://boyvue.com/media/logo-social.jpg';
    try {
      const first = await pool.query('SELECT thumbnail_path FROM image WHERE belongs_to_gallery=$1 ORDER BY view_count DESC LIMIT 1', [id]);
      if (first.rows.length) coverImage = `https://boyvue.com/media/${first.rows[0].thumbnail_path}`;
    } catch(e) {}
    
    // Get i18n SEO from database
    let seoData = null;
    try {
      const seoRes = await pool.query("SELECT seo_title, seo_description, seo_keywords FROM category_seo WHERE category_id=$1 AND language=$2", [id, lang]);
      if (seoRes.rows.length) seoData = seoRes.rows[0];
      if (!seoData && lang !== "en") {
        const seoEn = await pool.query("SELECT seo_title, seo_description, seo_keywords FROM category_seo WHERE category_id=$1 AND language=$2", [id, "en"]);
        if (seoEn.rows.length) seoData = seoEn.rows[0];
      }
    } catch(e) {}
    
    const meta = {
      title: seoData?.seo_title || `${name} | BoyVue Gallery`,
      description: seoData?.seo_description || `${bl} ${pc} photos and videos in ${name}. Free HD streaming.`,
      keywords: seoData?.seo_keywords || "",
      image: coverImage
    };
    
    const schema = {"@context":"https://schema.org","@type":"CollectionPage","name":meta.title,"description":meta.description,"numberOfItems":cat.photo_count||0};
    
    let body = `<h2>${esc(name)}</h2><p>${pc} items</p><div class="g">`;
    try {
      const imgs = await pool.query('SELECT id,title,thumbnail_path,view_count FROM image WHERE belongs_to_gallery=$1 ORDER BY view_count DESC LIMIT 48', [id]);
      for (const i of imgs.rows) body += `<div class="i"><a href="/v/${i.id}"><img src="/media/${i.thumbnail_path}" alt="${esc(i.title||'')}" loading="lazy"></a><h3><a href="/v/${i.id}">${esc((i.title||'Video').substring(0,40))}</a></h3><p>${(i.view_count||0).toLocaleString()} views</p></div>`;
    } catch(e) {}
    body += `</div>`;
    
    res.send(botHtml(meta, lang, `/c/${id}`, schema, body));
  } catch(e) {
    console.error('SEO /c/:id:', e.message);
    serveSpa(req, res);
  }
});

// Social share API endpoint
app.get('/api/share/:id', async (req, res) => {
  const id = parseInt(req.params.id);
  try {
    const r = await pool.query('SELECT id,title,thumbnail_path FROM image WHERE id=$1', [id]);
    if (!r.rows.length) return res.status(404).json({error:'Not found'});
    
    const img = r.rows[0];
    const url = `https://boyvue.com/v/${id}`;
    const shares = socialShareUrls(url, img.title || 'Video', `https://boyvue.com/media/${img.thumbnail_path}`);
    
    res.json({ url, title: img.title, image: `https://boyvue.com/media/${img.thumbnail_path}`, shares });
  } catch(e) {
    res.status(500).json({error: e.message});
  }
});

app.use(express.static(join(__dirname, '../dist')));
app.get('*', serveSpa);

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
